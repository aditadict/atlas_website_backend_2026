# Caddyfile for Atlas Digitalize API
# Domain: atlassite-api.atlasdigitalize.com

{
    # Global options
    email admin@atlasdigitalize.com

    # Disable automatic HTTPS (using Cloudflare certificates)
    auto_https off

    # Enable HTTP/3
    servers {
        protocol {
            experimental_http3
        }
    }
}

# Main API domain
atlassite-api.atlasdigitalize.com {
    # Use Cloudflare SSL certificates
    tls /etc/caddy/certs/atlasdigitalize.com.pem /etc/caddy/certs/atlasdigitalize.com.key

    # Enable compression
    encode gzip zstd

    # Logging
    log {
        output file /data/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }

    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"

        # Prevent content type sniffing
        X-Content-Type-Options "nosniff"

        # XSS Protection
        X-XSS-Protection "1; mode=block"

        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"

        # Remove server header
        -Server
    }

    # Handle OPTIONS requests for CORS
    @options {
        method OPTIONS
    }
    handle @options {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept"
        header Access-Control-Max-Age "86400"
        respond 204
    }

    # Reverse proxy to Laravel Octane
    reverse_proxy app:8000 {
        # Health checks
        health_uri /up
        health_interval 30s
        health_timeout 5s
        health_status 200

        # Load balancing (if scaled)
        lb_policy round_robin

        # Headers
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}

        # Timeouts
        transport http {
            read_timeout 300s
            write_timeout 300s
        }
    }
}

# HTTP to HTTPS redirect (handled automatically by Caddy)
# Caddy automatically redirects HTTP to HTTPS
